<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rust 中的内存布局 | ecrof88-blog</title>
    <meta name="description" content="Kovaak ini">
    <meta name="generator" content="VitePress v1.5.0">
    <link rel="preload stylesheet" href="/assets/style.DFXOSto1.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.DUljGIe_.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.CzgbgD4U.js">
    <link rel="modulepreload" href="/assets/chunks/framework.B0cMFUTE.js">
    <link rel="modulepreload" href="/assets/rustnotes_basic1.md.G4mY7iRo.lean.js">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar" data-v-7ad780c2 data-v-9fd4d1dd><div class="wrapper" data-v-9fd4d1dd><div class="container" data-v-9fd4d1dd><div class="title" data-v-9fd4d1dd><div class="VPNavBarTitle has-sidebar" data-v-9fd4d1dd data-v-9f43907a><a class="title" href="/" data-v-9f43907a><!--[--><!--]--><!--[--><img class="VPImage logo" src="/favicon.ico" alt data-v-ab19afbb><!--]--><span data-v-9f43907a>ecrof88-blog</span><!--[--><!--]--></a></div></div><div class="content" data-v-9fd4d1dd><div class="content-body" data-v-9fd4d1dd><!--[--><!--]--><div class="VPNavBarSearch search" data-v-9fd4d1dd><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-9fd4d1dd data-v-afb2845e><span id="main-nav-aria-label" class="visually-hidden" data-v-afb2845e> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-afb2845e data-v-815115f5><!--[--><span data-v-815115f5>Home</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-afb2845e data-v-bfe7971f><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-bfe7971f><span class="text" data-v-bfe7971f><!----><span data-v-bfe7971f>DISC Notes</span><span class="vpi-chevron-down text-icon" data-v-bfe7971f></span></span></button><div class="menu" data-v-bfe7971f><div class="VPMenu" data-v-bfe7971f data-v-20ed86d6><div class="items" data-v-20ed86d6><!--[--><!--[--><div class="VPMenuLink" data-v-20ed86d6 data-v-7eeeb2dc><a class="VPLink link" href="/discnotes/1.html" data-v-7eeeb2dc><!--[--><span data-v-7eeeb2dc>windows msys2使用fish</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-20ed86d6 data-v-7eeeb2dc><a class="VPLink link" href="/discnotes/2.html" data-v-7eeeb2dc><!--[--><span data-v-7eeeb2dc>WIN终端代理</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-20ed86d6 data-v-7eeeb2dc><a class="VPLink link" href="/discnotes/3.html" data-v-7eeeb2dc><!--[--><span data-v-7eeeb2dc>Neovim 基础学习笔记</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup active" data-v-afb2845e data-v-bfe7971f><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-bfe7971f><span class="text" data-v-bfe7971f><!----><span data-v-bfe7971f>Notes</span><span class="vpi-chevron-down text-icon" data-v-bfe7971f></span></span></button><div class="menu" data-v-bfe7971f><div class="VPMenu" data-v-bfe7971f data-v-20ed86d6><div class="items" data-v-20ed86d6><!--[--><!--[--><div class="VPMenuGroup" data-v-20ed86d6 data-v-a6b0397c><p class="title" data-v-a6b0397c>Rust Notes</p><!--[--><!--[--><div class="VPMenuLink" data-v-a6b0397c data-v-7eeeb2dc><a class="VPLink link active" href="/rustnotes/basic1.html" data-v-7eeeb2dc><!--[--><span data-v-7eeeb2dc>Basic1</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-20ed86d6 data-v-a6b0397c><p class="title" data-v-a6b0397c>CPP Notes</p><!--[--><!--[--><div class="VPMenuLink" data-v-a6b0397c data-v-7eeeb2dc><a class="VPLink link" href="/cppnotes/1.html" data-v-7eeeb2dc><!--[--><span data-v-7eeeb2dc>std中的variant</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-20ed86d6 data-v-a6b0397c><p class="title" data-v-a6b0397c>Java Notes</p><!--[--><!--[--><div class="VPMenuLink" data-v-a6b0397c data-v-7eeeb2dc><a class="VPLink link" href="/javanotes/1.html" data-v-7eeeb2dc><!--[--><span data-v-7eeeb2dc>自定义注解</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-9fd4d1dd data-v-3f90c1a5><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-3f90c1a5 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-9fd4d1dd data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ECROF88" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-9fd4d1dd data-v-f953d92f data-v-bfe7971f><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-bfe7971f><span class="vpi-more-horizontal icon" data-v-bfe7971f></span></button><div class="menu" data-v-bfe7971f><div class="VPMenu" data-v-bfe7971f data-v-20ed86d6><!----><!--[--><!--[--><!----><div class="group" data-v-f953d92f><div class="item appearance" data-v-f953d92f><p class="label" data-v-f953d92f>Appearance</p><div class="appearance-action" data-v-f953d92f><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-f953d92f data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-f953d92f><div class="item social-links" data-v-f953d92f><div class="VPSocialLinks social-links-list" data-v-f953d92f data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ECROF88" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-9fd4d1dd data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-9fd4d1dd><div class="divider-line" data-v-9fd4d1dd></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2488c25a><span class="vpi-align-left menu-icon" data-v-2488c25a></span><span class="menu-text" data-v-2488c25a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-883964e0><button data-v-883964e0>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-d8b57b2d data-v-42c4c606><div class="curtain" data-v-42c4c606></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-42c4c606><span class="visually-hidden" id="sidebar-aria-label" data-v-42c4c606> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0" data-v-51288d80 data-v-edd2eed8><div class="item" role="button" tabindex="0" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><h2 class="text" data-v-edd2eed8>DISC Notes</h2><!----></div><div class="items" data-v-edd2eed8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/discnotes/1.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>windows msys2使用fish</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/discnotes/2.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>WIN终端代理</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/discnotes/3.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>Neovim 基础学习笔记</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0 has-active" data-v-51288d80 data-v-edd2eed8><div class="item" role="button" tabindex="0" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><h2 class="text" data-v-edd2eed8>Notes</h2><!----></div><div class="items" data-v-edd2eed8><!--[--><section class="VPSidebarItem level-1 has-active" data-v-edd2eed8 data-v-edd2eed8><div class="item" role="button" tabindex="0" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><h3 class="text" data-v-edd2eed8>Rust Notes</h3><!----></div><div class="items" data-v-edd2eed8><!--[--><div class="VPSidebarItem level-2 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/rustnotes/basic1.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>Basic1</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1" data-v-edd2eed8 data-v-edd2eed8><div class="item" role="button" tabindex="0" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><h3 class="text" data-v-edd2eed8>CPP Notes</h3><!----></div><div class="items" data-v-edd2eed8><!--[--><div class="VPSidebarItem level-2 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/cppnotes/1.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>std中的variant</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1" data-v-edd2eed8 data-v-edd2eed8><div class="item" role="button" tabindex="0" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><h3 class="text" data-v-edd2eed8>Java Notes</h3><!----></div><div class="items" data-v-edd2eed8><!--[--><div class="VPSidebarItem level-2 is-link" data-v-edd2eed8 data-v-edd2eed8><div class="item" data-v-edd2eed8><div class="indicator" data-v-edd2eed8></div><a class="VPLink link link" href="/javanotes/1.html" data-v-edd2eed8><!--[--><p class="text" data-v-edd2eed8>自定义注解</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-sidebar has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-f610f197><div class="content" data-v-f610f197><div class="outline-marker" data-v-f610f197></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-f610f197>On this page</div><ul class="VPDocOutlineItem root" data-v-f610f197 data-v-53c99d69><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _rustnotes_basic1" data-v-e6f2a212><div><h1 id="rust-中的内存布局" tabindex="-1">Rust 中的内存布局 <a class="header-anchor" href="#rust-中的内存布局" aria-label="Permalink to &quot;Rust 中的内存布局&quot;">​</a></h1><h3 id="usize-isize" tabindex="-1">usize &amp; isize <a class="header-anchor" href="#usize-isize" aria-label="Permalink to &quot;usize &amp; isize&quot;">​</a></h3><p>usize 无符号整型 ,isiz 有符号整型。 在64位系统上——8bytes。 在32位系统上——4bytes。</p><h3 id="bool" tabindex="-1">bool <a class="header-anchor" href="#bool" aria-label="Permalink to &quot;bool&quot;">​</a></h3><p>长度和对齐长度都是1byte。</p><h3 id="array" tabindex="-1">array <a class="header-anchor" href="#array" aria-label="Permalink to &quot;array&quot;">​</a></h3><p>数组的内存布局是系统类型元组的有序组合 <code>size:n* size_of::&lt;T&gt;</code><code>align: align_of:&lt;T&gt;</code></p><h3 id="struct" tabindex="-1">struct <a class="header-anchor" href="#struct" aria-label="Permalink to &quot;struct&quot;">​</a></h3><p>结构体的对齐方式就是所有成员的对齐属性的最大值 Rust会在必要的位置填充空白的数据</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    b</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !==</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  111</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">   </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    c</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u16</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>内存布局不一定是写的顺序,在这里,b放在最前面,然后是c,a。 按4字节对齐,一共8字节。</p><h3 id="dst-dynamically-sized-types" tabindex="-1">DST (Dynamically Sized Types) <a class="header-anchor" href="#dst-dynamically-sized-types" aria-label="Permalink to &quot;DST (Dynamically Sized Types)&quot;">​</a></h3><p>Rust主要有两种主要的DST类型</p><ul><li><code>trait objects: dyn SomeTrait</code></li><li><code>slices: [T] ,str,和其他</code> 任何指向DST的指针都会变成一个fat pointer,包含DST类型信息 如何类型没有实现Sized,就无法知道东西的大小来产生合理的代码 几乎所有的地方都需要Sized： <ul><li>struct字段，函数参数，返回值，变量，数组</li><li>自定义的Type Bound 自动包含T:Sized,除非写明 T:?Sized 对于DST：</li><li>将非Sized类型放在宽指针后面，宽指针就是一个普通指针附加一个word-sized字段</li><li>可以提供给编译器所需要的关注指针的额外信息 例如：Box和Arc都支持存储宽指针，所以都支持T:?Sized</li></ul></li></ul><h3 id="地址、大小、值" tabindex="-1">地址、大小、值 <a class="header-anchor" href="#地址、大小、值" aria-label="Permalink to &quot;地址、大小、值&quot;">​</a></h3><h4 id="值删除的顺序" tabindex="-1">值删除的顺序 <a class="header-anchor" href="#值删除的顺序" aria-label="Permalink to &quot;值删除的顺序&quot;">​</a></h4><p>变量和函数的参数是按相反的顺序进行删除的 嵌套的值是按照源代码的顺序进行删除的</p><h4 id="可变引用是独占的" tabindex="-1">可变引用是独占的： <a class="header-anchor" href="#可变引用是独占的" aria-label="Permalink to &quot;可变引用是独占的：&quot;">​</a></h4><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> noalias</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,b</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:&amp;mut</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>可以断定在这里a和b一定是不同的值</p><p>可变引用只允许修改引用所指向的内存地址</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">i32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">42</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">i32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 33</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> mut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> y </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">i32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> z </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:&amp;mut</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">i32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;mut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> y;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // z只允许持有对y的一个可变引用 ，但是可通过z修改y的值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">z </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // z = &amp;mut &amp;x2; 不可以</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    println!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;y= {y}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 20</span></span></code></pre></div><h3 id="内部可变性" tabindex="-1">内部可变性 <a class="header-anchor" href="#内部可变性" aria-label="Permalink to &quot;内部可变性&quot;">​</a></h3><ul><li>通过共享引用获得可变引用 <code>Mutex 、RefCell</code> 二者是实现内部可变性的智能指针，允许在逻辑上不可变的数据结构内部进行修改 两种智能指针都依赖于 Rust 标准库中的 <code>UnsafeCell</code> 类型。 内部的“不安全”操作被封装在这些智能指针的实现中，用户在正常使用时不需要直接编写 <code>unsafe</code> 代码</li><li>通过共享引用替换值 <code>std::sync::atomic,std::cell:Cell</code> 没有提供可变引用到内部值 提供就地操作值的方法 <code>Cell</code> 不允许你获取内部的可变引用，因此你不能通过共享引用直接修改内部结构，而是只能通过 <code>Cell</code> 提供的接口方法替换整个值 Cell 无法跨线程共享</li></ul><h4 id="泛型生命周期" tabindex="-1">泛型生命周期 <a class="header-anchor" href="#泛型生命周期" aria-label="Permalink to &quot;泛型生命周期&quot;">​</a></h4><ol><li>实现Drop的类型：如果一个类型实现了Drop trait，那么在丢弃（drop）该类型的实例时，Rust会认为这个操作使用了该类型的泛型生命周期或类型参数。这意味着在drop方法中，你可能会使用到这些引用，因此借用检查器会确保在drop之前，这些引用仍然是合法的。</li><li>未实现Drop的类型：如果一个类型没有实现Drop trait，那么在丢弃该类型的实例时，Rust不会认为这个操作使用了该类型的泛型生命周期或类型参数。因此，类型内部的引用可以被忽略，借用检查器不会对它们进行额外的检查。 例子：</li></ol><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">impl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Drop</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> for</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> My</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> drop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;mut</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        print!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> mut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">i32</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">My</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">i32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Mytype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">x};</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // let b =&amp;mut x; 报错，因为在Mytype{value:&amp;x} 有对x的不可变借用</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 如果没有实现Drop Trait，就不会检查</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="variant" tabindex="-1">Variant <a class="header-anchor" href="#variant" aria-label="Permalink to &quot;Variant&quot;">​</a></h3><ul><li>covariant 协变 某类型只能用子类型代替 &#39;b:&#39;a ,&#39;b是&#39;a的子类，&#39;b live longer than &#39;a 例如 &amp;&#39;static T 可以代替 &amp;&#39;a T</li><li>invariant 不变 例如 &amp;mut T, 对T来说是不变的</li><li>contravariant 逆变 函数对参数的要求越低，参数可发挥的作用越大 函数的入参是逆变的，出参是协变的</li></ul><h4 id="repr" tabindex="-1">repr <a class="header-anchor" href="#repr" aria-label="Permalink to &quot;repr&quot;">​</a></h4><ol><li>repr(C) 布局方式和C,C++ 编译器对同类型的布局兼容</li></ol><ul><li>例如使用FFI与其他语言交互</li><li>Rust会生成一个匹配其他语言编译器期望的布局</li></ul><ol start="2"><li>#[repr(Rust)]允许重新对字段排序,可以减少填充</li><li>#[repr(packed)] 字段之间无需任何填充</li></ol><ul><li>承担不对齐造成的访问性能损失</li><li>可利用于内存有限、低带宽网络连接发送内存表示</li><li>若cpu仅支持对齐操作，可导致程序崩溃</li></ul><ol start="4"><li>#[repr(align(n))] 在内存中至少按照n字节的对齐 <ul><li>例如 保证内存中连续存储的不同值位于CPU的不同的缓存行上，避免false sharing</li><li>缓存行(cache line)：缓存有缓存行组成，缓存以一个缓存行作为一个单位进行处理</li><li>伪共享：多线程环境下。当多个线程各自操作不同的变量时，这些变量恰好位于同一个缓存行内。虽然线程之间并没有逻辑上的数据共享，但由于 CPU 缓存一致性协议（如 MESI 协议）的存在，当一个线程修改了缓存行内的数据，其他线程中对应缓存行的数据就会被标记为无效，迫使这些线程从内存中重新加载数据。</li><li>避免多个独立的数据被放到同一个缓存行中，从而减少因伪共享导致的缓存行无效</li></ul></li><li>#[repr(transparent)] <ul><li>这个属性通常用于创建“透明包装”类型，即新类型（newtype）模式</li></ul><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> #[repr(transparent)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Meters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f32</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div>Meters 类型的内存表示与 f32 完全相同</li></ol><h4 id="其他类型的内存表示" tabindex="-1">其他类型的内存表示 <a class="header-anchor" href="#其他类型的内存表示" aria-label="Permalink to &quot;其他类型的内存表示&quot;">​</a></h4><ol><li>Tuple： Like Struct</li><li>数组</li><li>Union：所有字段共享内存,对齐就是所有变体最大的 <ul><li>Union的读取需要放在unsafe里面</li></ul></li><li>enum ：和Union一样，额外有一个隐藏共享字段，用于存储鉴别符</li></ol><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">#[repr(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">u8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">enum</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> OverflowingDiscriminantError2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    MaxMinusOne</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 254</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 254</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,               </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 255</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    MaxPlusOne</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         // 应该是256，但枚举溢出了。</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>零枚举类型 <code>enum ZeroVariants{}</code> 零变体枚举与 never类型等效，但它不能被强转为其他类型。 enum 本质是个中tagged union, 是sum type,用一个 byte 来存储 type tag. enum存在一种优化就是 使用padding 中未定义的内存来存储 type tag</p><h4 id="static-dispatch" tabindex="-1">static dispatch <a class="header-anchor" href="#static-dispatch" aria-label="Permalink to &quot;static dispatch&quot;">​</a></h4><p><code>impl</code> 为每个类型都复制一份，每份有自己的地址，可以用来跳转 对于方法给定的任何副本，分排到的地址都是静态已知的(编译期间已知)</p><h4 id="单态化" tabindex="-1">单态化 <a class="header-anchor" href="#单态化" aria-label="Permalink to &quot;单态化&quot;">​</a></h4><p>一个泛型类型到多个非泛型类型的过程叫单态化 代价：</p><ul><li>所有示例单独编译，编译时间增加</li><li>程序更大，每个单态化的都会有一段自己的机器码(二进制文件 膨胀)</li><li>指令在泛型方法的不同实例种无法共享，CPU指令缓存效率降低</li></ul><h4 id="动态分发-dynamic-dispatch" tabindex="-1">动态分发(dynamic dispatch) <a class="header-anchor" href="#动态分发-dynamic-dispatch" aria-label="Permalink to &quot;动态分发(dynamic dispatch)&quot;">​</a></h4><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ffff</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:&amp;dyn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> SomeTrait</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">){}</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-1bcd8184><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-1bcd8184><span class="visually-hidden" id="doc-footer-aria-label" data-v-1bcd8184>Pager</span><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link prev" href="/discnotes/3.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Previous page</span><span class="title" data-v-1bcd8184>Neovim 基础学习笔记</span><!--]--></a></div><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link next" href="/cppnotes/1.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>Next page</span><span class="title" data-v-1bcd8184>std中的variant</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"api-examples.md\":\"49ZwWsyi\",\"cppnotes_1.md\":\"CKK2v5mh\",\"discnotes_1.md\":\"mLHSa_KP\",\"discnotes_2.md\":\"D_VVCgr7\",\"discnotes_3.md\":\"CkCEUYns\",\"gjdw_1.md\":\"BkKKPEpC\",\"gjdw_2.md\":\"CYJqLD3T\",\"index.md\":\"B-ppDn_i\",\"javanotes_1.md\":\"mawY2PcK\",\"markdown-examples.md\":\"BMIfrBcP\",\"readme.md\":\"BBG8Wvn7\",\"rustnotes_basic1.md\":\"G4mY7iRo\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"ecrof88-blog\",\"description\":\"Kovaak ini\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/favicon.ico\",\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"DISC Notes\",\"items\":[{\"text\":\"windows msys2使用fish\",\"link\":\"/discnotes/1\"},{\"text\":\"WIN终端代理\",\"link\":\"/discnotes/2\"},{\"text\":\"Neovim 基础学习笔记\",\"link\":\"/discnotes/3\"}]},{\"text\":\"Notes\",\"items\":[{\"text\":\"Rust Notes\",\"items\":[{\"text\":\"Basic1\",\"link\":\"/rustnotes/basic1\"}]},{\"text\":\"CPP Notes\",\"items\":[{\"text\":\"std中的variant\",\"link\":\"/cppnotes/1\"}]},{\"text\":\"Java Notes\",\"items\":[{\"text\":\"自定义注解\",\"link\":\"/javanotes/1\"}]}]}],\"sidebar\":[{\"text\":\"DISC Notes\",\"items\":[{\"text\":\"windows msys2使用fish\",\"link\":\"/discnotes/1\"},{\"text\":\"WIN终端代理\",\"link\":\"/discnotes/2\"},{\"text\":\"Neovim 基础学习笔记\",\"link\":\"/discnotes/3\"}]},{\"text\":\"Notes\",\"items\":[{\"text\":\"Rust Notes\",\"items\":[{\"text\":\"Basic1\",\"link\":\"/rustnotes/basic1\"}]},{\"text\":\"CPP Notes\",\"items\":[{\"text\":\"std中的variant\",\"link\":\"/cppnotes/1\"}]},{\"text\":\"Java Notes\",\"items\":[{\"text\":\"自定义注解\",\"link\":\"/javanotes/1\"}]}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/ECROF88\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>